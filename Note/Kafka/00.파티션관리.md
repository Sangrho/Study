## 파티션 관리
파티션을 관리하는 카프카 도구는 두 개가 있다.
하나는 리더 리플리카를 다시 선추하는 것이고, 다른 하나는 브로커에게 파티션을 할당하는 저수준 유틸리티다.

### 선호 리플리카 선출
여러 리플리카 브로커 중, 하나의 리플리카 브로커만이 파티션 리더가 될 수 있으며, 모든 프로듀서와 컨슈머의 메세지 쓰기와 읽기 작업은 그 브로커에서 수행된다.
카프카 내부에서는 그 브로커가 첫 번째 동기화 리플리카(in-sync replica, ISR) 로 정의된다.
그러나 그 브로커가 중단되었다가 다시 시작될 때는 어떤파티션의 리더도 맡지 않게 된다.

      * 리더 자동 조정
      자동으로 리더를 조정하는 브로커 구성이 있다.
      그러나 업무용으로 카프카를 사용할 때는 그 것의 사용을 권장하지 않는다.
      자동 조정 모듈로 인해 성능에 지대한 영향을 줄 수 있어서, 규모가 큰 클러스터에서 클라이언트가 메세지를 읽거나 쓸 때는 긴 시간 동안 일시 정지될 수 있기 때문이다.
      
브로커들이 자동으로 파티션 리더를 선출하는 것은 여러 가지 상황에서 생길 수 있으며, 이 경우 클러스터 컨트롤러가 자동으로 파티션의 이상적인 리더를 선택한다.
그러나 kafka-preferred-replicaelection.sh 를 사용하면 우리가 원할 때 선호 리플리카 선출을 통해 각 파티션의 리더를 선출할 수 있다.

8개의 파티션으로 구성된 하나의 토픽을 갖는 클러스터의 모든 파티션에 대해 선호 리플리카 선출을 시작시키는 예를 보면 다음과 같다.

    $> kafka-preferred-replica-election.sh\
    > --zookeeper zoo1.example.com:2181/kafka-cluster

그러나 파티션 개수가 많은 클러스터의 경우에는 한 번의 선호 리플리카 선출로 실행될 수 없을 것이다.
그 이유는 이렇다. 선호 리플리카 선출 요처은 클러스터 메타데이터의 주키퍼 노드에 저장되어야 한다.
그러나 요청 내용의 크기가 주키퍼 노드)기본 값이 1MB) 보다 크면 해당 요청의 실행에 실패하게 된다.
따라서 이때에는 JSON 객체를 포함하는 파일을 생성해야 한다. 그리고 JSON 객체에는 여러 단계로 나누어서 실행되도록 리더 선ㄴ출 파티션 내역이 포함되어야 한다.

    {
      "partitions": [
        {
          "partition":1,
          "topic" : "foo"
        },
        {
          "partition":2,
          "topic":"foobar"
        }
      ]
    }

이 파티션 내용을 담고 있는 json 파일을 사용하여 선호 리플리카 선출을 시작시키는 명령어는 아래와 같다.

    $> kafka-preferred-replica-election.sh \
    --zookeeper zoo1.example.com:2181/kafka-cluster \
    --path-to-json-file partitions.json


### 파티션의 리플리카 변경하기
때로는 파티션의 리플리카 할당을 변경해야 한다. 예를 들어 다음과 같은 경우다.

- 토픽의 파티션들이 브로커들에게 고르게 배분되지 않았을 때
- 하나의 브로커가 오프라인이 될 때
- 새로운 브로커가 추가되어 클러스터의 작업량을 공유할 필요가 있을 때

이때 kafka-reassign-partitions.sh 를 사용할 수 있다. 이 도구는 세 단계로 사용하며, 마지막 세 번째 단계는 생략할 수 있다.
첫 번째 단계에서는 브로커 리스트와 토픽 리스트를 사용하여 파티션 재할당 리스트를 생성한다.
그리고 두 번째 단계에서는 그 리스트에 있는 대로 파티션 재할당을 실행한다. 마지막 세 번째 단계에서는 재할당으로 생성된 리스트를 사용해서 파티션 재할당의 진철도나 완료를 확인한다.

파티션 재할당 리스트를 생성하기 위해서는 해당 파티션들을 지정한 토픽 리스트의 JSON 객체를 포함하는 파일을 생성해야 한다.

    {
      "topics": [
        {
          "topic":"foo"
        },
        {
          "topic":"foo1"
        }
      ],
      "version":1
    }
 
'topics.json' 이라는 파일에 JSON 객체로 저장된 토픽 리스트를 사용해서 각 토픽들의 파티션을 0과 1의 ID를 갖는 브로커로부터 ID가 2와 3인 브로커로 재할당하기 위해 파티션 재할당 리스트를 생성하는 예는 다음과 같다.

    $> kafka-reassign-partitions.sh \
    --zookeeper zoo1.example.com:2181/kafka-cluster \
    --generate --topics-to-move-json-file topics.json --broker-list 2,3

이 예에서 보듯이, 실행 결과는 두 개의 JSON 객체로 출력된다. 하나는 현재 할당되어 있는 각 토픽들의 파티션을 나타내고, 다른 것은 제안되어 생성된 파티션 할당 리스트를 나타낸다.

      * 리플리카를 재할당할 때 고려사항
      하나의 브로커로부터 많은 파티션이 삭제될 때는, 해당 브로커를 셧다운했다가 다시 시작시킨 후에 파티션 재할당을 시작하는 것이 좋다.
      이렇게 하면 해당 브로커가 리더로 할당되었던 파티션들의 새로운 리더로 클러스터의 다른 브로커들이 지정된다. 또한 파티션 재할당의 처리 성능을 많이 증가시키고 클러스터에 주는 영향을 줄일 수 있다.
      
      
      
      
      
   
   
   Referenced from Kafka The Definitive Guide
