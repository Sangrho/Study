### 장애 복구 이후 어플리케이션의 시작 오프셋 (미러링 기능 있을 경우)

1. 자동 오프셋 재설정

아파치 카프카 컨슈머는 이전에 커밋된 오프셋이 없을 때 어떻게 실행할 것인지를 나타내느 ㄴ구성 속성(파티션의 맨 앞 또는 제일 끝에서 읽기 시작하는) 을 갖는다. 
커밋하는 오프셋을 주키퍼에 쓰는 구버전(0.9.0 이전) 의 컨슈머를 사용 중이면서, 해당 오프셋을 어떻게 하든 미러링하지 않는다면,
다음 중 하나의 옵션을 선택해야 한다.
사용 가능한 데이터의 맨 앞부터 읽기 시작하면서 많은 중복 데이터를 처리하거나(auto.offset.reset="earliest"),
제일 끝으로 이동하여 알 수 없는 개수(바라건 대 적은 수)의 데이터를 유실하거나(auto.offset.reset="latest")다.
만일 우리 어플리케이션에서 문제없이 중복 데이터를 처리하거나 일부 데이터 유실이 그릐 중요하지 않다면, 이 옵션의 선택은 매우 쉽다.
장애 복구 중인 토픽의 제일 끝으로 이동하는 것이 여전히 가장 많이 사용하는 장애 복구 방법이기 때문이다.

2. 오프셋 토픽을 복제하기

카프카 0.8 버전 이상의 컨슈머를 사용 중이라면, 컨슈머가 자신의 오프셋들을 주키퍼에 쓰지 않고 카프카의 특별한 토픽인 __consumer_offsets 에 커밋한다.
만일 이 토픽을 DR(재해복구) 클러스터에 미러링한다면, 컨슈머가 DR 클러스터의 데이터를 읽기 시작할 때 자신의 이전 오프셋을 선택하여 그 위치부터 계속 읽을 수 있다.
이것은 간단하지만 다음에 설명하는 여러 가지 주의사항을 고려해야 한다.
첫 번째, 주 클러스터의 오프셋이 DR 클러스터의 오프셋과 일치한다는 보장이 없다. 예를 들어, 주 클러스터에 특정 토픽을 생성하였고, 3일 동안 이 포틱에만 데이터를 저장한다고 가정해보자.
또한 이 토픽이 생성된 일주일 후에 해당 토픽의 미러링을 시작한다고 해보자. 이 경우 주 클러스터에서 사용 가능한 첫 번째 오프셋은 57000000과 같은 값이 될 수 있다.
(더 이전 데이터들은 처음 4일 동안 있었다가 이미 삭제되었다). 그러나 DR 클러스터의 첫 번째 오프셋은 0이 될 것이다. 따라서 DR 클러스터의 57000003 오프셋(이것이 컨슈머가 읽을 다음 데이터이므로) 을 읽으려고 하는 컨슈머는 읽기에 실패할 것이다.
두 번째, 토픽이 처음 생성되었을 때 곧바로 미러링을 시작했고, 주 클러스터 토픽과 DR 클러스터 토픽 모두 오프셋 0에서 시작한다고 하더라도 프로듀서가 메세지 쓰기를 재시도하면 두 클러스터의 오프셋이 달라질 수 있다.
간단히 말해서, 주 클러스터와 DR 클러스터 간에 오프셋들을 보존하는 카프카 미러링 솔루션은 현재 없다.
세 번째, 주 클러스터와 DR 클러스터의 오프셋들이 완벽하게 보존되었더라도, 컨슈머가 커밋한 오프셋은 이 포스셋의 데이터보다 일찍 또는 늦게 처리될 수 있다.
왜냐하면 주 클러스터와 DR 클러스터 간의 지연(데이터와 오프셋을 쓰는 시점 차이) 과 카프카의 트랜잭션 처리 기능이 없기 때문이다.
따라서 장애 복구 중인 컨슈머가 자신이 커밋했던 오프셋의 데이터를 찾을 수 없게 될 수 있다. 또는 DR 클러스터의 가장 최근 커밋 오프셋이 주 클러스터의 가장 최근 커밋 오프셋보다 이전 것일 수 있다.

3. 시간 기방 장애 복구



4. 외부 오프셋 매핑



